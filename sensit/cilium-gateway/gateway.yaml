---
apiVersion: gateway.networking.k8s.io/v1
kind: Gateway
metadata:
  name: public-gateway
  namespace: default
  annotations:
    # Request specific IP from MetalLB for sticky assignment
    metallb.universe.tf/loadBalancerIPs: "10.10.210.32"
    # Alternative: use deprecated spec.loadBalancerIP instead
    # io.cilium/lb-ipam-ips: "10.10.210.32"
spec:
  gatewayClassName: cilium-ipv4
  listeners:
  - protocol: HTTP
    port: 80
    name: web-gw
    allowedRoutes:
      namespaces:
        from: All
  - protocol: HTTPS
    port: 443
    name: web-gw-https
    tls:
      certificateRefs:
        - kind: Secret
          name: sensit-swarm-labs-tls
    allowedRoutes:
      namespaces:
        from: All
---
apiVersion: gateway.networking.k8s.io/v1
kind: Gateway
metadata:
  name: public-gateway-ipv6
  namespace: default
  annotations:
    # Request specific IPv6 from MetalLB for sticky assignment
    metallb.universe.tf/loadBalancerIPs: "fdde:5353:4242:210:0100::20"
spec:
  gatewayClassName: cilium-ipv6
  listeners:
  - protocol: HTTP
    port: 80
    name: web-gw
    allowedRoutes:
      namespaces:
        from: All
  - protocol: HTTPS
    port: 443
    name: web-gw-https
    tls:
      certificateRefs:
        - kind: Secret
          name: sensit-swarm-labs-tls
    allowedRoutes:
      namespaces:
        from: All
---
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: longhorn
spec:
  parentRefs:
    - name: public-gateway
      namespace: default
    - name: public-gateway-ipv6
      namespace: default
  hostnames:
    - "storage.sensit.labs.thesw4rm.com"
  rules:
  - matches:
    - path:
        type: PathPrefix
        value: /
    backendRefs:
    - name: longhorn-frontend
      namespace: longhorn-system
      port: 80
---
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: bitty
spec:
  parentRefs:
    - name: public-gateway
      namespace: default
    - name: public-gateway-ipv6
      namespace: default
  hostnames:
    - "pass.sensit.labs.thesw4rm.com"
  rules:
  - matches:
    - path:
        type: PathPrefix
        value: /
    backendRefs:
    - name: bitty
      namespace: sensit-stuff
      port: 80
---
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: docs
spec:
  parentRefs:
    - name: public-gateway
      namespace: default
    - name: public-gateway-ipv6
      namespace: default
  hostnames:
    - "docs.sensit.labs.thesw4rm.com"
  rules:
  - matches:
    - path:
        type: PathPrefix
        value: /
    backendRefs:
    - name: docs
      namespace: sensit-stuff
      port: 80
